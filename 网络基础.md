---
title: "第二阶段学习总结"
author: Logan Ren
date: June 15, 2022
output:
  word_document:
    path: D://Data//Desktop//第二阶段学习总结-任金山.docx
    toc: true
    toc_depth: 6
    number_sections: true
---

# 网络基础

## 企业网络架构

传统企业网络架构主要分为三层, 第一层是接入层, 该层负责管理同一局域网下不同应用的通信, 第二层是汇聚层, 负责不同局域网之间的通信, 第三层核心层负责与外网通信. 新的企业网络架构着重于优化, 冗余, 纵深, 管理四点, 即选择通信的最优路径, 通过冗余设备解决单点故障问题并增加网络的可靠性, 分为多层来过滤请求, 统一运维管理设备. 未来的企业网络架构则主要向云上发展.

## 数据链路层

### 报文首部

```shell
<7byte前导码><1byte帧起始><6byte目的主机mac地址><6byte源主机mac地址><4byte标签><2byte类型>
```

### vlan

虚拟局域网主要解决的是当局域网中接入设备过多, 网络广播时消耗过大的问题. 通过在mac帧报文头部加入VLAN ID来划分VLAN, 一般的默认ID即PVID为1. valn id存储在首部标签(tag)字段中.

### 链路类型

用户主机与交换机之间的链路一般为接入链路(access), 交换机与交换机之间的链路一般为干道链路(trunk). acess链路中交换机接收报文时会自动增加tag VLAN ID即为该端口的PVID, 发出报文时移除tag. trunk链路中交换机接收报文时如果报文中没有tag, 则将添加上pvid. 发送时, 如果tag中的id与pvid相同, 则移除tag.

## 网络层

IP地址分为网络部分和主机部分, IP地址由32个二进制位组成, 通常用点分十进制形式表示. 主机位全零为网段位, 全一为广播地址.

> 网关管理与其他网段通信.

### 报文首部

#### 首部格式

```shell
<4bit版本号><4bit首部长度><8bit区分服务><16bit总长度>
<16bit标识><4bit标志><12bit片偏移>
<8bit生存时间><8bit上层协议><16bit校验和>
<32bit源地址>
<32bit目的地址>
<0~40Byte选项>
```

##### 版本号

IP协议的版本号4.

##### 首部长度

单位为4Byte.

##### 区分服务

在现在的以太网中已经被淘汰.

##### 总长度

单位为1Byte.

##### 标识

信源机产生的每个数据报的唯一标识符, 标识同一数据报的不同分片.

##### 标志

目前只有后两位DF位和MF位有效, DF位等于一时表示强制不允许分片, MF位等于一时表示不是最后一片.

##### 片偏移

数据段距首位的偏移量, 单位为8Byte, 标识分片在原来数据报中的位置.

##### 生存时间

TTL(Time To Live), 可通过路由器数的最大值, 每经过一个路由器便减一, 若为零丢弃该数据包, 便发送ICMP报文通知源主机.

##### 上层协议

运输层协议, eg: TCP, UDP.

##### 校验和

因为每经过一个路由器, IP报文首部便会跟着变化一次, 数据部分并不改变, 只校验数据报的首部, 分成多个16bit字段, 进行二进制反码加法运算, 结果取反, 得到校验和.

##### 选项

主要用于控制和测试, 可选字段.

### IP地址分类

IP地址分为A, B, C, D, E类. A类有8位网络位, B类有16位网络位, C类有24位网络位, D类为组播IP, E类为保留IP.

### 私有地址

A类私有地址为10.0.0.0-255.255.255.255, B类私有地址为172.16.0.0-172.31.255.255, C类私有地址为192.168.0.0-192.168.255.255.

### 子网掩码

子网掩码的主要作用是屏蔽IP地址的一部分, 以区分网络ID和主机ID.

> 可变长子网掩码(VLSM): 合理划分网段, 节省IP地址.

## 路由

### 自治系统

由同一个管理机构管理, 使用统一路由策略的路由器的集合.

### 路由表

路由表中包含该路由器可以达到的网络. 每一条路由条目包含达到该网络的IP地址(destination), 网络掩码(mask), 协议(proto), 优先级(preference), 度量值(cost), 下一跳地址(nexthop), 出接口(interface).

> 最长掩码匹配规则, 路由表中若有多条到达目的网络的路由条目, 选择掩码最长的条目.
> 优先级越小的协议越优先.
> 度量值越小代表该路径开销越小, 选择开销更小的路径.

### 直连路由

同一个局域网下直连的路由.

### 静态路由

手动配置的单向路由.

### 浮动路由

路由器自行管理的路由表.

### 负载分担

目的地址相同, 下一跳地址不同, 协议相同, 优先级相同, 开销相同的路由线路称为负载分担, 相当于热备.

### 路由备份

目的地址相同, 下一跳地址不同, 协议相同, 优先级不同, 开销相同的路由线路称为路由备份, 相当于冷备.

### 缺省路由

缺省路由是目的地址和掩码都全为零的特殊路由. 如果报文的目的地址无法匹配路由表中的任何一项, 路由器将选择依照缺省路由来转发报文.

### vlan间路由

使用三层交换机来实现不同vlan间通信即vlan端口间的通信由交换机内部路由模块实现.

## 解决单点故障

### 环路

环形部署提高了网络的可靠性. 当同时也会引发其他问题: 广播风暴(访问不存在的主机, 会在网络中回环查询主机), 网络中的主机会收到重复数据帧, mac地址表震荡(访问不存在的主机会修改源主机的mac地址表目录, 使得对应主机接口错误). 但为了保证网络可靠性, 仍需要使用环形网络, 可通过STP协议来解决上述问题.

### 单生成树协议(STP)

STP主要是逻辑上切断环路, 但一旦出现故障, 阻塞的线路会重新连上, 在STP配置中交换机角色分为根桥交换机和非根桥交换机, 端口角色分为根端口, 指定端口, 预备端口.

#### 操作

1. 选举一个根桥(比较桥ID, 桥ID小的为根桥交换机).
2. 每个非根交换机需要选举且只能选举一个根端口(和根桥交换机直连的非根交换机端口为根端口).
3. 每个网段选举一个指定端口(到达根桥交换机开销最小的端口为指定端口, 如果开销相同则选则桥ID最小的端口).
4. 阻塞非根, 非指定端口.

> 桥ID计算方法: 优先级加上交换机的mac地址, 优先级默认都是32768, 修改时只能以4096的倍数修改.
> 根桥没有根端口.

#### 缺陷

网络中发生变化时重新选举要耗时45s(切换三次状态, 每次耗时15s). 由于阻塞端口的存在, 部分线路没有连通, 不同vlan无法连通, 无法分担流量且可能使用的是次优路径. 

### 多生成树协议(MSTP)

为了解决单生成树协议的缺陷, 每个vlan生成一棵自己的生成树, 使得阻塞端口只阻塞特定vlan. mst域内可以生成多棵生成树, 每个生成树都称为一个msti, msti之间相互独立, 且每个msti的计算过程基本与rstp的计算过程相同.

### 虚拟路由冗余协议(VRRP)

单网关一旦出现故障, 本网段中所有以该设备为网关的主机都无法连接外网. 但部署多个网关可能造成网关间ip地址冲突, 主机会频繁切换网络出口. 为了解决上述问题引入VRRP协议.

通过优先级区分主备路由, 将两个物理路由合并为一个虚拟路由, 使得主机只能感知到一个网关, 但当主路由故障后, 切换为备份路由, 解决了三次的单点故障.

#### 操作

网络初始化后, 根据优先级启动主备路由, 定时器先结束的即为主路由, 且每秒通知备份路由主路由工作正常, 若备份路由连续三次没有收到通知则切换为主路由. 主路由恢复后, 不会立即抢占, 会有抢占时延(避免回包丢失).

> 利用vrrp的联动功能监视上行接口或链路故障, 进行主备切换.

## 镜像技术

为了即不影响正常业务进行, 又能获取完整报文用于实时分析网络状况, 引入了镜像技术. 镜像的定义是将镜像端口(源端口)的报文复制一份到观察端口(目的端口). 镜像的优点主要为两点. 一是不影响原有网络, 快捷方便, 二是采集的是实时数据流, 真实可靠.

### 数据采集

#### 用途

1. 业务实时监控.
2. 故障处理分析.
3. 网络流量优化.

#### 方法

1. 分光器物理采集.
2. NMS集中采集.

##　访问控制列表(ACL)

ACL根据需求定义过滤条件以及匹配条件后执行的动作.

### 分类

#### 基本ACL

编号范围为2000-2999, 根据源IP地址等参数来进行匹配.

#### 高级ACL(常用)

编号范围为3000-3999, 根据源IP地址, 目的IP地址, 源端口, 目的端口等参数来进行匹配.

#### 二层ACL

编号范围为4000-4999, 根据源mac地址, 目的mac地址, 以太帧协议类型等参数来进行匹配.

### 规则

每个ACL可以包含多个规则, RTA根据规则来对数据流量从上至下进行过滤, 默认最后一条规则是拒绝所有, 当前面所有规则都未成功匹配则执行最后一条.

## 策略路由(PBR)

为了实现人为控制网络流量可达性以及调整网络流量路径, 引入了PBR, 即直接通过依据用户制定的策略进行转发, 且该策略优于路由表转发, 这种方式称为策略路由. 实现方式主要是使用Traffic-Filter工具对数据进行过滤, 使用ACL工具匹配目标流量, 然后对目标流量定义行为, 修改下一跳, 实现根据自定义策略转发. 

> 常用工具: Traffic-Fiter, Traffic-Policy, Policy-Based-Route等.

### 优点

1. 基于转发平面, 不会影响路由表表项, 且设备收到报文后, 会先查找策略路由进行匹配转发, 若匹配失败, 则再查找路由表进行转发.
2. 可基于源地址, 目的地址, 协议类型, 报文大小等进行策略制定.
3. 需手工逐跳配置, 以保证报文按策略进行转发.

## NAT

自治系统中的私有地址无法直接与外网进行通信需要经过NAT转换后才可以. NAT一般部署在连接内网和外网的网关设备上.

### 静态NAT

一个公网IP只会分配给唯一且固定的内网主机, 静态NAT实现了私有地址和公有地址的一对一映射.

### 动态NAT

动态NAT基于地址池来实现私有地址和公有地址的转换.

### NAPT

网络地址端口转换基于将多个私有地址映射到同一个共有地址的不同端口来实现私有地址和公有地址的转换.

### NAT Server

通过配置NAT服务器, 可以使外网用户访问内网服务器.

# wireshark

## 包过滤

一条基本的表达式由过滤项, 过滤关系, 过滤值三项组成. 过滤项由协议, 协议字段两大部分构成. 过滤关系主要包含等于, 小于, 大于等几种常见关系. 过滤值为设定的过滤项应满足过滤关系的标准.

>复合表达式过滤规则: 将多个表达式通过连接词拼接为一个表达式, 实现条件搜寻.

### 常见协议

#### 应用层

http, https, ssh

#### 传输层

tcp, udp, sctp

#### 网络层

ipv4, ipv6, icmp

#### 数据链路层

eter, vlan, pppoe

#### 应-传输层

ssl/tls

#### 网-数据层

arp

### 常见协议字段

#### 地址

源/目的IP地址, 源/目的mac地址

#### 端口

源/目的端口

#### 包长度

包含IP, TCP, UDP等包的长度.

#### contains

可查询payload中关键字.

### 常见过滤关系

1. eq, ==
2. ne, !=
3. ge, >=
4. le, <=
5. gt, >
6. lt, <

### 常用连接词

1. and, &&
2. or, ||
3. not, !
4. xor, ^^
5. []

## 捕获过滤

一条基本的表达式由捕获项, 捕获参数, 捕获值三项组成. 捕获项由协议, 数据流方向两大部分构成, 捕获默认协议为所有协议, 流向src or det方向. 捕获参数指捕获值得类型, 主要由host, net, port等, 默认参数为host.

## 远程捕获

可通过在被捕获主机上安装winpcap软件并开启对应端口, 在客户端添加远程主机+端口号来捕获远程主机.

## HTTPS取证

1. 搭建web server并生成私钥.
2. 使用wireshark自带解码将经由ssl加密后得数据包还原为http(编辑-首选项-SSL-Edit).
3. 在客户端访问web server, 使用wireshark捕获报文信息.
4. 追踪所捕获文件中从服务器下载文件得http流.
5. 保存捕获原始文件.
6. 删除报文头部内容, 获取原始数据.
7. 还原原文件.

## AIM取证

1. 确定通信对象.
2. 截取传输信息.
3. 截取传输文件.
4. 传输文件恢复.

> AIM所有得文件传输都以TCP进行传输选中对应TCP流使用TCP追踪流功能即可查看对应传输文件信息.

## 邮件取证

1. 参看SMTP信息, 追踪TCP流, 可通过"MAIL FORM" "RCPT TO"字段确定发件人和收件人. 并且可通过Base 64解码对AUTH LOGIN所携带的Base 64编码信息进一步确定发件人信息和密码.
2. 传输文件取证,追踪包含有邮件信息的TCP流量即可得到其具体信息.
3. 邮件信息解码.
4. 附件解析还原.

## 基本信息统计工具

1. 捕获文件属性(文件宿主机的详细信息, 包括硬件信息及应用程序信息, 文件抓包时所获取的流量信息).
2. 协议分级统计.
3. 端点统计.
4. 对话栏.
5. http-计数(Response Packets, Request Packets).
6. http-请求(访问URI及URL信息).
7. http-负载分配(http响应地址及响应状态, 请求域名及其服务器地址).
8. 数据流图-TCP, HTTP流.
9.  IP属性(Dst/Src Address Port, Protocol Type)

## 信息统计

### 网络性能

1. IO图表.
2. 单台主机流量图表.
3. 单台可疑主机判定.

### 吞吐量测算

1. 链路吞吐量测算.
2. 应用程序吞吐量测算.
3. TCP吞吐量测算.
4. 链路连接性能测算(RTT).

### TCP重传判断

1. TCP数据包抖动情况.
